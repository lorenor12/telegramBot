import json
import requests
import time
import urllib
import re

# Key of the Bot do not upload to an open Repository
bot_key = open("BotKey").read()
# Url of the Telegram API
url = "https://api.telegram.org/bot{}/".format(bot_key)

# Gets the Content of a request-URL
def getContent(url):
    response = requests.get(url)
    content = response.content.decode("utf8")
    return content


# Gets the Juicy Json of a request-URL
def getJsonFromUrl(url):
    content = getContent(url)
    js = json.loads(content)
    return js


# Gets the updates from the Telegram API
def getUpdates(offset=None):
    geturl = url + "getUpdates?timeout=100"
    if offset:
        geturl += "&offset={}".format(offset)
    return getJsonFromUrl(geturl)


# Gets The ID of the last update.
def getLastUpdateId(updates):
    update_ids = []
    for update in updates["result"]:
        update_ids.append(int(update["update_id"]))
    return max(update_ids)


# Gets the last message and it's ID.
def getLastMessageAndId():
    updates = getUpdates()
    num_updates = len(updates["result"])
    last_update = num_updates - 1
    text = updates["result"][last_update]["message"]["text"]
    chat_id = updates["result"][last_update]["message"]["chat"]["id"]
    return text, chat_id


# Sends a message to a Chat using it's ID.
def sendMessage(message, chat):
    message = urllib.parse.quote_plus(message)
    message_url = url + "sendMessage?chat_id={}&text={}".format(chat, message)
    requests.get(message_url)


# Gets all parameters of a command.
def getParams(command):
    params = re.split("\s", command)
    params.pop(0)
    params = "".join(params)
    params = re.split(",\s*", params)
    return params[0], params[1]


# Kicks an user out of a Group chat.
def kickUser(chat, user):
    kick_url = url + "kickChatMember?chat_id={}&user_id={}".format(chat, user)
    if requests.get(kick_url):
        print("get rekt")
        sendMessage("Ciao!", chat)


# Reacts to the commands, that are specified in this function.
def reactToCommands(command, chat, user):
    if command == "hello":
        sendMessage("hello", chat)
    elif command == "kick":
        kickUser(chat, user)

# Checks the new messages for commands and specific phrases.
def checkUpdates(updates):
    for update in updates["result"]:
        text = update["message"]["text"]
        chat = update["message"]["chat"]["id"]
        user = str(update["message"]["from"]["id"])
        try:
            if update["message"]["entities"][0]["type"]:
                reactToCommands(text[1:], chat, user)
        except Exception as e:
            print(e)
            print("checking for commands failed")
        if "text" in update["message"]:
            if text.lower() == "nÃ¶, halts maul":
                sendMessage("Sry hab nen schlechten Tag.", chat)
                kickUser(chat, user)


# Prints out all updates.
def echoAll(updates):
    for update in updates["result"]:
        print(update)


# Starts the Bot and processes all new messages.
def main():
    last_update_id = None
    while True:
        updates = getUpdates(last_update_id)
        if len(updates["result"]) > 0:
            last_update_id = getLastUpdateId(updates) + 1
            echoAll(updates)
            checkUpdates(updates)
        time.sleep(0.5)


if __name__ == "__main__":
    main()
